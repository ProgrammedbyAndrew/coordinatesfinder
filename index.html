<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Coordinate Recorder (Manual Refresh)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .coords {
      font-size: 1.2rem;
      margin-bottom: 1rem;
    }
    .label {
      font-weight: bold;
    }
    .row {
      margin: 10px 0;
    }
    .row input {
      padding: 6px;
      font-size: 1rem;
      width: 200px;
    }
    button {
      padding: 8px 14px;
      font-size: 1rem;
      cursor: pointer;
      margin-right: 10px;
    }
    .status {
      margin-top: 1rem;
      color: green;
    }
    .error {
      margin-top: 1rem;
      color: red;
    }
    hr {
      margin: 20px 0;
    }
    #loadBtn {
      background-color: #6c757d;
      color: #fff;
    }
    #refreshBtn {
      background-color: #28a745;
      color: #fff;
    }
    #recordBtn {
      background-color: #007bff;
      color: #fff;
    }
    #downloadBtn {
      background-color: #17a2b8;
      color: #fff;
    }
    #dataTextArea {
      width: 100%;
      height: 150px;
    }
  </style>
</head>
<body>
  <h1>Coordinate Recorder (Manual Refresh)</h1>

  <!-- Current position display -->
  <div class="coords">
    <div>
      <span class="label">Latitude:</span>
      <span id="lat">--</span>
    </div>
    <div>
      <span class="label">Longitude:</span>
      <span id="lon">--</span>
    </div>
  </div>

  <!-- Buttons to get a fix, record it, download data, etc. -->
  <div class="row">
    <button id="refreshBtn">Refresh Coordinates</button>
    <button id="recordBtn">Record</button>
    <button id="downloadBtn">Download Data</button>
    <button id="loadBtn">Load Coordinates</button>
  </div>

  <!-- Input for location name -->
  <div class="row">
    <label class="label" for="locName">Location Name:</label>
    <input type="text" id="locName" placeholder="e.g. Truck #1" />
  </div>

  <!-- Status messages -->
  <div id="message"></div>

  <hr/>

  <!-- Text area to see everything we've recorded -->
  <textarea id="dataTextArea" readonly></textarea>

  <script>
    let currentLat = null;
    let currentLon = null;

    let recordedPoints = []; // in-memory store

    const latEl = document.getElementById('lat');
    const lonEl = document.getElementById('lon');
    const locNameInput = document.getElementById('locName');
    const messageEl = document.getElementById('message');
    const dataTextArea = document.getElementById('dataTextArea');

    const refreshBtn = document.getElementById('refreshBtn');
    const recordBtn = document.getElementById('recordBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const loadBtn = document.getElementById('loadBtn');

    // --- Refresh Coordinates (on-demand) ---
    refreshBtn.addEventListener('click', () => {
      messageEl.innerHTML = '';
      if (!('geolocation' in navigator)) {
        messageEl.innerHTML = '<p class="error">Geolocation not supported in this browser.</p>';
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          currentLat = pos.coords.latitude;
          currentLon = pos.coords.longitude;
          latEl.textContent = currentLat.toFixed(6);
          lonEl.textContent = currentLon.toFixed(6);
          messageEl.innerHTML = '<p class="status">Coordinates refreshed.</p>';
        },
        (err) => {
          messageEl.innerHTML = `<p class="error">Error getting location: ${err.message}</p>`;
          console.error("Geolocation error:", err);
        },
        { enableHighAccuracy: true }
      );
    });

    // --- Record the currently displayed coords + name ---
    recordBtn.addEventListener('click', () => {
      messageEl.innerHTML = '';
      if (currentLat === null || currentLon === null) {
        messageEl.innerHTML = '<p class="error">Please Refresh Coordinates before recording.</p>';
        return;
      }
      const nameVal = locNameInput.value.trim();
      if (!nameVal) {
        messageEl.innerHTML = '<p class="error">Please enter a location name.</p>';
        return;
      }

      // Build an object for the coordinate
      const entry = {
        name: nameVal,
        latitude: currentLat,
        longitude: currentLon,
        timestamp: new Date().toISOString()
      };
      recordedPoints.push(entry);

      // Save to localStorage in case we refresh the page
      localStorage.setItem('savedCoordinates', JSON.stringify(recordedPoints));

      // Confirm to the user
      messageEl.innerHTML = `<p class="status">Recorded "${nameVal}" @ ${currentLat.toFixed(5)}, ${currentLon.toFixed(5)}</p>`;
      updateDataTextArea();
    });

    // --- Download the recordedPoints as a .txt file ---
    downloadBtn.addEventListener('click', () => {
      messageEl.innerHTML = '';
      if (recordedPoints.length === 0) {
        messageEl.innerHTML = '<p class="error">No data to download yet.</p>';
        return;
      }

      // Convert the array to CSV-like text
      let fileContent = "Location Name,Latitude,Longitude,Timestamp\n";
      recordedPoints.forEach(pt => {
        fileContent += `"${pt.name}",${pt.latitude},${pt.longitude},${pt.timestamp}\n`;
      });

      // Create a Blob from the text
      const blob = new Blob([fileContent], { type: 'text/plain' });
      const blobUrl = URL.createObjectURL(blob);

      // Create a temporary link to trigger the download
      const tempLink = document.createElement('a');
      tempLink.href = blobUrl;
      tempLink.download = 'coordinates.txt'; // or .csv if you prefer
      document.body.appendChild(tempLink);
      tempLink.click();
      document.body.removeChild(tempLink);

      setTimeout(() => URL.revokeObjectURL(blobUrl), 1000);
    });

    // --- Load from localStorage if exists ---
    loadBtn.addEventListener('click', () => {
      messageEl.innerHTML = '';
      const saved = localStorage.getItem('savedCoordinates');
      if (!saved) {
        messageEl.innerHTML = '<p class="error">No saved coordinates found in localStorage.</p>';
        return;
      }
      try {
        recordedPoints = JSON.parse(saved);
        if (!Array.isArray(recordedPoints)) {
          recordedPoints = [];
        }
        messageEl.innerHTML = `<p class="status">Loaded ${recordedPoints.length} records from localStorage.</p>`;
        updateDataTextArea();
      } catch (err) {
        console.error("Error parsing savedCoordinates:", err);
        messageEl.innerHTML = '<p class="error">Failed to parse saved coordinates.</p>';
      }
    });

    // Display the entire list in the textarea
    function updateDataTextArea() {
      let text = '';
      recordedPoints.forEach((pt, i) => {
        text += `[${i+1}] "${pt.name}" => (${pt.latitude.toFixed(5)}, ${pt.longitude.toFixed(5)}) at ${pt.timestamp}\n`;
      });
      dataTextArea.value = text;
    }

    // Optional: auto-load if you want to pull data from localStorage immediately
    // loadBtn.click();

  </script>
</body>
</html>
